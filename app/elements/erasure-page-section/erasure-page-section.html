<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="erasure-page-section">
  <template>
    <style>
      :host {
        display: block;
      }

    </style>

    <template>
      <div id="countDown">{{count}}</div>
    </template>

    <template is="dom-if" if="{{hasTitle(sectionContent.title)}}">
      <h2>{{sectionContent.title}}</h2>
    </template>

    <template is="dom-if" if="{{hasTitle(sectionContent.subtitle)}}">
      <h3>{{sectionContent.subtitle}}</h3>
    </template>

    <template is="dom-if" if="{{hasTitle(sectionContent.blockquote)}}">
      <blockquote>{{sectionContent.blockquote}}</blockquote>
    </template>

    <template is="dom-repeat" items="{{sectionContent.content}}">
      <p inner-h-t-m-l="{{item.paragraph}}"></p>
    </template>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'erasure-page-section',

        properties: {
          sectionContent: {
            type: Object,
            notify: true
          },
          count: {
            type: Number,
            value: 0,
            notify: true,
            observer: 'nextCount'
          }

        },

        hasTitle: function hasTitle(title) {
          return '' == !title;
        },

        _randomArrayMax: function randomArrayMax(numMax) {
          var randomArray = [];
          var maxRes = ((numMax * 10) / 100);
          for ( var i = 0; i < maxRes; i++ ) {
            randomArray[ i ] = Math.floor(Math.random() * numMax) + 1;
          }
          console.log('removing words at position ' + JSON.stringify(randomArray));
          return randomArray;
        },

        _curateParagraph: function curate(paragraph) {
          var wordParagraphList = paragraph.match(/\w+/g);
          //count the words and randomizes the injection of the tags
          this._randomArrayMax(wordParagraphList.length)
            .forEach(function (pos) {
              //wordParagraphList[ pos ] = undefined === wordParagraphList[ pos ] ? '' : wordParagraphList[ pos ].replace(/\./gi, '_');
              //wordParagraphList[ pos ] = (''+wordParagraphList[ pos ]).replace(/\./gi, '_');
              var word = '' + wordParagraphList[ pos ];
              console.log('about to check ' + word);
              wordParagraphList[ pos ] = word.replace(/./g,'_');
//                ((Math.random() < 0.5) && /^[a-zA-Z0-9]{6,}/.test(word)) ?
//                //'<erasure-synonym foo=' + word + '></erasure-synonym>' :
//              '<b>' + word + '</b>' :
//              '<span class="hideme">' + word + '</span>';

            });
          return wordParagraphList.join(' ');
        },

        _doIt: function () {
          console.log(':::called');
          var newContent = this.get('sectionContent.content');
          for ( var i = 0, l = newContent.length; i < l; i++ ) {
            if ( typeof (newContent[ i ].paragraph) === 'string' ) {
              var curatedPgph = this._curateParagraph(newContent[ i ].paragraph);
              //Forcing the deep array node to update
              this.set('sectionContent.content.' + i + '.paragraph', curatedPgph);
            } else {
              console.error('::: wrong content at the paragraph index ' + i)
            }
          }
        },
//
//        ready: function () {
//          this.nextCount();
//        },

        nextCount: function () {
          // will not call `destroy` more than once per 100ms
          this.debounce('destroy', function() {
            if ( this.count < 100 ) {
              var count = this.get('count');
              this.set('count', count + 1);
              console.log('here '+ count);
              this._doIt();
            }
          }, 3000);

        }

//        ready: function () {
//          this.async(this._doIt, 5000);
//        },


      });
    })();
  </script>
</dom-module>
