<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="erasure-page-section">
  <template>
    <style>
      :host {
        display: block;
      }

    </style>

    <template>
      <div id="countDown">{{count}}</div>
    </template>

    <template is="dom-if" if="{{hasContent(sectionContent.title)}}">
      <h2>{{sectionContent.title}}</h2>
    </template>

    <template is="dom-if" if="{{hasContent(sectionContent.subtitle)}}">
      <h3>{{sectionContent.subtitle}}</h3>
    </template>

    <template is="dom-if" if="{{hasContent(sectionContent.blockquote)}}">
      <blockquote>{{sectionContent.blockquote}}</blockquote>
    </template>

    <template is="dom-repeat" items="{{sectionContent.content}}">
      <p inner-h-t-m-l="{{item.paragraph}}"></p>
    </template>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer( {
        is: 'erasure-page-section',

        properties: {
          sectionContent: {
            type: Object,
            notify: true
          },
          count: {
            type: Number,
            value: 0,
            notify: true,
            observer: 'nextCount'
          }

        },

        _randomArrayMax: function randomArrayMax( max ) {
          var randomArrayFromWordsSize = [];
          var maxRes = ((max * 10) / 100);
          for ( var i = 0; i < maxRes; i++ ) {
            randomArrayFromWordsSize[ i ] = Math.floor( Math.random() * max );
          }
          return randomArrayFromWordsSize;
        },

        _curateLongString: function curate( paragraph ) {
          var wordParagraphList = paragraph.split( ' ' );
          //count the words and randomizes the injection of the tags
          this._randomArrayMax( wordParagraphList.length )
            .forEach( function ( pos ) {
              var word = '' + wordParagraphList[ pos ];
              wordParagraphList[ pos ] = word.replace( /./g, '_' );
            } );
          return wordParagraphList.join( ' ' );
        }
        ,

        _operatedContent: function ( originalContent, target ) {
          if ( this.hasContent( originalContent ) ) {
            var curatedString = this._curateLongString( originalContent );
            this.set( target, curatedString );
            return true
          } else {
            console.error( '::: wrong content at ' + target );
            return false;
          }
        },

        _doIt: function () {
          [ 'title', 'blockquote', 'subtitle', 'content' ] //Type of content defined inside erasure's json
            .forEach( ( section ) => {
              var sectionContent = this.get( 'sectionContent' );
              if ( sectionContent.hasOwnProperty( section ) ) {
                var target = 'sectionContent.' + section;
                var originalContent = this.get( target );
                if ( !this._operatedContent( originalContent, target ) && typeof (originalContent) === 'object' && originalContent.length > 0 ) {
                  originalContent.forEach( ( element, index ) => {
                    this._operatedContent( element.paragraph, target + '.' + index + '.paragraph' )
                  } )
                }
              }
            } )
        },

        hasContent: function hasContent( content ) {
          return typeof content === 'string' && '' !== content;
        },

        nextCount: function () {
          // will not call `destroy` more than once per 3000ms, and data binding will update it
          this.debounce( 'destroy', function () {
            if ( this.count < 100 ) {
              var count = this.get( 'count' );
              this.set( 'count', count + 1 );
              this._doIt();
            }
          }, 3000 );
        }

      } )
      ;
    })
    ();
  </script>
</dom-module>
